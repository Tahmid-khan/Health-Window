<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin • Appointments</title>

  <!-- Internal CSS: identical style to Doctors/Patients tabs -->
  <style>
    :root{
      --green-gradient: linear-gradient(to bottom, #00c97d, #00b3a4);
      --light-bg:#f7f9fc; --text:#333; --white:#fff; --muted:#6b7280;
      --radius:12px; --shadow:0 2px 10px rgba(0,0,0,.08); --sidebar:220px;
      --brand:#00b3a4; --danger:#ef4444; --ok:#16a34a; --warn:#d97706;
      --font:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--light-bg);color:var(--text);font-family:var(--font)}
    .wrap{display:grid;grid-template-columns:var(--sidebar) 1fr;min-height:100vh}

    /* Sidebar */
     .sidebar{
      width:var(--sidebar);background:var(--green-gradient);color:#fff;
      padding:20px;display:flex;flex-direction:column;align-items:center
    }
    .sb-head{text-align:center;margin-bottom:30px}
    .avatar{width:70px;height:70px;border-radius:50%;background:#fff;color:#00b391;
      display:flex;align-items:center;justify-content:center;font-weight:800;font-size:24px;margin:auto}
    .sb-name{margin-top:10px;font-weight:700}
    .menu{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
    .menu a{display:block;color:#e6fffb;text-decoration:none;padding:10px 12px;border-radius:10px}
    .menu a.active,.menu a:hover{background:rgba(255,255,255,.15)}

    /* Content */
    main{padding:28px}
    .page-title{font-size:28px;font-weight:800;margin:0 0 6px}
    .page-sub{color:var(--muted);margin-bottom:18px}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
    .search{flex:1;min-width:260px;position:relative}
    .search input{width:100%;padding:12px 14px;border:1px solid #e7e7e7;border-radius:12px;background:#fff;outline:none}
    .btn{background:#fff;border:1px solid #e7e7e7;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{background:#f3f4f6}

    /* Card + table */
    .card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #eef0f4}
    .card .title{font-weight:700}
    .status{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px 18px;border-bottom:1px solid #eef0f4}
    th{color:#6b7280;text-align:left;font-weight:600;background:#fafbfc}
    .actions{display:flex;gap:8px}
    .empty{color:var(--muted);text-align:center;padding:26px}

    /* Badges & buttons */
    .badge{padding:.22rem .55rem;border-radius:999px;font-size:11px;border:1px solid #e7e7e7;background:#fff}
    .badge.ok{background:#e8fff1;color:#065f46;border-color:#b8f3cc}
    .badge.warn{background:#fff7ed;color:#92400e;border-color:#fed7aa}
    .badge.muted{background:#f3f4f6;color:#6b7280;border-color:#e5e7eb}
    .btn.danger{border-color:#f1c4c4;background:#fff5f5;color:#b91c1c}
    .btn.danger:hover{background:#ffecec}
    .muted{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .clip{max-width:380px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-head">
        <div class="avatar">HW</div>
        <div class="sb-name">Admin</div>
      </div>
      <ul class="menu">
        <li><a href="admin-dashboard.html">Dashboard</a></li>
        <li><a href="admin-doctors.html">Doctors</a></li>
        <li><a href="admin-patients.html">Patients</a></li>
        <li><a class="active" href="admin-appointments.html">Appointments</a></li>
        <li><a href="#" id="logoutBtn">Logout</a></li>

      </ul>
    </aside>

    <!-- Content -->
    <main>
      <h1 class="page-title">Appointments</h1>
      <div class="page-sub">Search, view and manage all appointments</div>

      <div class="toolbar">
        <div class="search">
          <input id="searchInput" type="text" placeholder="Search by patient, doctor, status..."/>
        </div>
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>

      <section class="card">
        <div class="head">
          <div class="title">Appointments List</div>
          <div id="statusText" class="status"></div>
        </div>

        <div class="table">
          <table>
            <thead>
              <tr>
                <th style="min-width:220px">Patient</th>
                <th style="min-width:220px">Doctor</th>
                <th class="nowrap">Date</th>
                <th class="nowrap">Time</th>
                <th>Status</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="apptsBody">
              <tr><td colspan="7" class="empty">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Internal JS -->
  <script>
    const API_BASE = 'http://localhost:5000/api/admin/appointments';

    const els = {
      tbody: document.getElementById('apptsBody'),
      search: document.getElementById('searchInput'),
      refresh: document.getElementById('refreshBtn'),
      status: document.getElementById('statusText')
    };

    const escapeHtml = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');

    const fmtDate = (d) => {
      if (!d) return '';
      const dt = new Date(d);
      if (!isNaN(dt)) return dt.toLocaleDateString();
      return d; // server may already format yyyy-mm-dd
    };

    function badgeForStatus(status=''){
      const s = status.toLowerCase();
      if (s.includes('pending')) return `<span class="badge warn">Pending</span>`;
      if (s.includes('approved') || s.includes('confirmed') || s.includes('completed')) return `<span class="badge ok">${escapeHtml(status)}</span>`;
      if (s.includes('cancel')) return `<span class="badge muted">Cancelled</span>`;
      return `<span class="badge muted">${escapeHtml(status || '—')}</span>`;
    }

    function setEmpty(msg){
      els.tbody.innerHTML = `<tr><td colspan="7" class="empty">${msg}</td></tr>`;
    }

    function renderRows(list){
      if (!Array.isArray(list) || list.length === 0){
        setEmpty('No appointments found');
        return;
      }
      els.tbody.innerHTML = list.map(a => `
        <tr data-id="${a.appointment_id}">
          <td>
            <div style="display:flex;flex-direction:column;gap:2px">
              <div style="font-weight:600">${escapeHtml(a.patient_name || '')}</div>
              <div class="muted">${a.user_id ? 'Patient ID: '+a.user_id : ''}</div>
            </div>
          </td>
          <td>
            <div style="display:flex;flex-direction:column;gap:2px">
              <div style="font-weight:600">${escapeHtml(a.doctor_name || '')}</div>
              <div class="muted">${a.doctor_id ? 'Doctor ID: '+a.doctor_id : ''}</div>
            </div>
          </td>
          <td class="nowrap">${escapeHtml(fmtDate(a.appointment_date))}</td>
          <td class="nowrap">${escapeHtml(a.appointment_time || '')}</td>
          <td>${badgeForStatus(a.status)}</td>
          <td class="clip" title="${escapeHtml(a.notes || '')}">${escapeHtml(a.notes || '')}</td>
          <td>
            <div class="actions">
              <button class="btn danger" onclick="deleteAppt(${Number(a.appointment_id)})">Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function loadAppointments(search=''){
      try{
        els.status.textContent = 'Loading…';
        setEmpty('Loading…');
        const url = new URL(API_BASE);
        if (search) url.searchParams.set('search', search);
        const res = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        renderRows(data);
        els.status.textContent = `Showing ${data.length} appointment${data.length!==1?'s':''}`;
      }catch(err){
        console.error(err);
        els.status.textContent = 'Failed to load appointments';
        setEmpty('Failed to load appointments');
      }
    }

    async function deleteAppt(id){
      if (!confirm('Delete this appointment?')) return;
      const row = els.tbody.querySelector(`tr[data-id="${id}"]`);
      const ph = document.createElement('tr');
      ph.innerHTML = `<td colspan="7" class="empty">Deleting…</td>`;
      if (row) row.replaceWith(ph);

      try{
        const res = await fetch(`${API_BASE}/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        ph.remove();
        // reload remaining
        loadAppointments(els.search.value.trim());
      }catch(err){
        console.error(err);
        if (ph.isConnected) ph.replaceWith(row);
        alert('Failed to delete appointment.');
      }
    }
    window.deleteAppt = deleteAppt;

    // search (debounced)
    let t=null;
    els.search.addEventListener('input', e=>{
      clearTimeout(t);
      t=setTimeout(()=>loadAppointments(e.target.value.trim()), 350);
    });

    // refresh
    els.refresh.addEventListener('click', ()=>{
      els.search.value='';
      loadAppointments('');
    });

    // first load
    loadAppointments();

      // --- Logout: clear any client session and redirect ---
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', (e) => {
    e.preventDefault();
    try { localStorage.removeItem('hw_admin'); sessionStorage.clear(); } catch {}
    location.replace('admin-login.html'); // adjust if file is elsewhere
  });
}


  </script>
</body>
</html>
